{% extends "base.html" %}
{% load i18n static inventree_extras %}

{% block page_title %}
{% inventree_title %} | {{ part.name }} â€” {% trans "Product Tree" %}
{% endblock page_title %}

{% block breadcrumbs %}
<li class="breadcrumb-item">
  <a href="{% url 'plugin:product_tree:product-tree-home' %}">{% trans "Product Tree" %}</a>
</li>
<li class="breadcrumb-item active" aria-current="page">{{ part.name }}</li>
{% endblock breadcrumbs %}

{% block content %}
<div class="d-flex align-items-center justify-content-between flex-wrap gap-3 mb-3">
  <div>
    <h1 class="h3 mb-0">{{ part.name }}</h1>
    <p class="text-muted mb-0">{% blocktrans %}Part ID: {{ part.pk }}{% endblocktrans %}</p>
  </div>
  {% if part.get_absolute_url %}
  <a class="btn btn-outline-secondary" href="{{ part.get_absolute_url }}">
    <span class="fas fa-box-open me-1" aria-hidden="true"></span>
    {% trans "View part" %}
  </a>
  {% endif %}
</div>

<div class="card shadow-sm">
  <div class="card-header d-flex align-items-center justify-content-between flex-wrap gap-3">
    <strong>{% trans "BOM hierarchy" %}</strong>
    <div class="d-flex align-items-center flex-wrap gap-3">
      <div class="d-flex align-items-center gap-2">
        <label class="form-label mb-0" for="maxDepth">{% trans "Max depth" %}</label>
        <input
          id="maxDepth"
          type="number"
          class="form-control form-control-sm"
          value="{{ default_max_depth }}"
          min="0"
          max="{{ max_depth_limit }}"
          style="max-width: 6rem;"
        />
      </div>
      <div class="form-check mb-0">
        <input class="form-check-input" type="checkbox" id="includeSubstitutes" />
        <label class="form-check-label" for="includeSubstitutes">{% trans "Include substitutes" %}</label>
      </div>
      <button class="btn btn-sm btn-outline-primary" type="button" onclick="reloadTree()">
        <span class="fas fa-sync-alt me-1" aria-hidden="true"></span>
        {% trans "Reload" %}
      </button>
    </div>
  </div>
  <div class="card-body">
    <div id="graph" class="border rounded p-3 bg-body-tertiary" style="white-space: pre; overflow:auto;"></div>
    <pre id="errors" class="text-danger mt-3 mb-0"></pre>
  </div>
</div>

<!-- Mermaid (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script src="{% static 'product_tree/tree.js' %}"></script>
<script>
  const dataUrl = "{% url 'plugin:product_tree:product-tree-data' pk=part.pk %}";
  function reloadTree(){
    const depthInput = document.getElementById('maxDepth');
    const substitutesInput = document.getElementById('includeSubstitutes');
    const md = depthInput ? depthInput.value : {{ default_max_depth }};
    const params = new URLSearchParams({max_depth: md});
    if (substitutesInput && substitutesInput.checked){
      params.append('include_substitutes', '1');
    }
    window.ProductTree.renderMermaidFromEndpoint(`${dataUrl}?${params.toString()}`, 'graph', 'errors');
  }
  document.addEventListener('DOMContentLoaded', () => {
    if (window.mermaid) { window.mermaid.initialize({startOnLoad: false}); }
    reloadTree();
  });
</script>
{% endblock content %}
