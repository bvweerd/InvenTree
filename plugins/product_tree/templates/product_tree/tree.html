
{% extends "page_base.html" %}
{% load i18n static %}
{% block heading %}{{ part.name }} ({{ part.pk }}) â€” {% trans "Product Tree" %}{% endblock %}
{% block content %}
<div class="panel panel-default">
  <div class="panel-heading">
    <strong>{% trans "BOM hierarchy" %}</strong>
    <div class="pull-right" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
      <label>{% trans "Max depth" %}:
        <input
          id="maxDepth"
          type="number"
          class="form-control input-sm"
          value="{{ default_max_depth }}"
          min="0"
          max="{{ max_depth_limit }}"
          style="width:80px; display:inline-block;"
        />
      </label>
      <label class="checkbox-inline" style="margin:0;">
        <input type="checkbox" id="includeSubstitutes" />
        {% trans "Include substitutes" %}
      </label>
      <button class="btn btn-sm btn-default" onclick="reloadTree()">{% trans "Reload" %}</button>
    </div>
  </div>
  <div class="panel-body">
    <div id="graph" style="white-space: pre; overflow:auto;"></div>
    <pre id="errors" style="color:#a94442;"></pre>
  </div>
</div>

<!-- Mermaid (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script src="{% static 'product_tree/tree.js' %}"></script>
<script>
  const detailUrl = "{% url 'product-tree-detail' pk=part.pk %}";
  const dataUrl = "{% url 'product-tree-data' pk=part.pk %}";
  function reloadTree(){
    const depthInput = document.getElementById('maxDepth');
    const substitutesInput = document.getElementById('includeSubstitutes');
    const md = depthInput ? depthInput.value : {{ default_max_depth }};
    const params = new URLSearchParams({max_depth: md});
    if (substitutesInput && substitutesInput.checked){
      params.append('include_substitutes', '1');
    }
    window.ProductTree.renderMermaidFromEndpoint(`${dataUrl}?${params.toString()}`, 'graph', 'errors');
  }
  document.addEventListener('DOMContentLoaded', () => {
    if (window.mermaid) { window.mermaid.initialize({startOnLoad: false}); }
    reloadTree();
  });
</script>
{% endblock %}
